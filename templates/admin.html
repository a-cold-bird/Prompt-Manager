{% extends 'base.html' %}
{% block title %}Admin Dashboard - Prompt Manager{% endblock %}

{% block content %}
<div class="page-container" style="max-width: 1280px;">

    <div class="d-flex flex-column flex-md-row justify-content-between align-items-end mb-5 animate-up">
        <div>
            <h2 class="fw-bold art-title mb-1">Control Center</h2>
            <p class="text-secondary small mb-0 fw-medium ls-1 text-uppercase">
                System Management & Moderation
            </p>
        </div>

        <div class="d-flex align-items-center gap-3 mt-3 mt-md-0">
             <button class="btn border-0 shadow-sm rounded-pill px-4 py-2 fw-bold text-secondary transition-bg d-flex align-items-center" style="background: var(--btn-bg);"
                     data-bs-toggle="modal" data-bs-target="#tagsModal">
                <i class="bi bi-tags-fill me-2 text-primary opacity-75"></i>标签管理
             </button>

             <div class="d-flex align-items-center ps-1 pe-3 py-1 shadow-sm rounded-pill" style="background: var(--btn-bg);">
                 <div class="rounded-circle bg-secondary bg-opacity-10 d-flex align-items-center justify-content-center me-2"
                      style="width: 32px; height: 32px;">
                     <i class="bi bi-person-fill text-secondary"></i>
                 </div>
                 <span class="small fw-bold" style="color: var(--text-primary);">{{ current_user.username }}</span>
             </div>
        </div>
    </div>

    <div class="d-flex justify-content-center mb-5 animate-up" style="animation-delay: 0.1s;">
        <nav class="segmented-control shadow-sm p-1" style="background: var(--btn-bg);">
            <a href="{{ url_for('admin.dashboard', tab='pending') }}"
               class="nav-link px-4 py-2 text-decoration-none {{ 'active' if active_tab == 'pending' else '' }}">
                待审核
                {% if pending_images|length > 0 %}
                <span class="badge bg-danger ms-2 rounded-pill shadow-sm" style="transform: scale(0.9);">{{ pending_images|length }}</span>
                {% endif %}
            </a>
            <a href="{{ url_for('admin.dashboard', tab='approved') }}"
               class="nav-link px-4 py-2 text-decoration-none {{ 'active' if active_tab == 'approved' else '' }}">
                已发布库
            </a>
            <a href="{{ url_for('admin.dashboard', tab='data-mgmt') }}"
               class="nav-link px-4 py-2 text-decoration-none {{ 'active' if active_tab == 'data-mgmt' else '' }}">
                系统设置
            </a>
        </nav>
    </div>

    <div class="tab-content animate-up" style="animation-delay: 0.2s;">

        <div class="tab-pane fade {{ 'show active' if active_tab == 'pending' else '' }}">
            {% if pending_images|length > 0 %}

                <div class="d-flex justify-content-between align-items-center mb-4 px-2">
                    <div class="text-secondary small fw-bold text-uppercase ls-1">
                        Queue ({{ pending_images|length }})
                    </div>
                    <form action="{{ url_for('admin.approve_all') }}" method="POST" onsubmit="return confirm('确定要一次性通过所有 {{ pending_images|length }} 张作品吗？');">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                        <button type="submit" class="btn btn-success rounded-pill shadow-sm fw-bold py-2 px-4"
                                style="background: linear-gradient(180deg, #34c759 0%, #30b753 100%); border: none;">
                            <i class="bi bi-check2-all me-2"></i>一键全部通过
                        </button>
                    </form>
                </div>

                <div class="row row-cols-1 row-cols-md-2 row-cols-xl-3 g-4">
                    {% for img in pending_images %}
                    <div class="col">
                        <div class="pending-gallery-card">
                            <div class="pending-img-zone">
                                {% set img_dict = img.to_dict() %}
                                <img src="{{ img_dict.thumbnail_path or img_dict.file_path }}" loading="lazy">
                                <div class="position-absolute top-0 start-0 m-3">
                                    <span class="badge bg-warning bg-opacity-75 backdrop-blur shadow-sm border border-white border-opacity-25" style="color: #000;">
                                        Pending
                                    </span>
                                </div>
                            </div>

                            <div class="p-4 d-flex flex-column flex-grow-1">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h5 class="fw-bold mb-0 text-truncate pe-2">{{ img.title }}</h5>
                                    <small class="text-muted fw-medium">{{ img.created_at.strftime('%H:%M') }}</small>
                                </div>

                                <div class="small text-secondary mb-3 d-flex align-items-center">
                                    <i class="bi bi-person-circle me-2 opacity-50"></i>
                                    {{ img.author or 'Anonymous' }}
                                </div>

                                <div class="rounded-3 p-3 mb-4 flex-grow-1 border border-secondary border-opacity-5" style="background: var(--btn-bg);">
                                    <p class="small text-secondary mb-0 text-clamp-3 font-monospace" style="font-size: 0.8rem; line-height: 1.6;">
                                        {{ img.prompt or 'No prompt provided...' }}
                                    </p>
                                </div>

                                <div class="d-flex align-items-center gap-2 mt-auto pt-3 border-top border-secondary border-opacity-10">
                                    <form action="{{ url_for('admin.approve', img_id=img.id) }}" method="POST" class="flex-grow-1 m-0">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button class="btn btn-success w-100 rounded-pill shadow-sm fw-bold py-2"
                                                style="background: linear-gradient(180deg, #34c759 0%, #30b753 100%); border: none;">
                                            <i class="bi bi-check-lg me-1"></i> 通过
                                        </button>
                                    </form>

                                    <a href="{{ url_for('admin.edit_image', img_id=img.id, next=request.full_path) }}"
                                       class="btn-circle-icon text-secondary" style="background: var(--btn-bg);" title="编辑">
                                        <i class="bi bi-pencil-fill" style="font-size: 0.9rem;"></i>
                                    </a>

                                    <form action="{{ url_for('admin.delete', img_id=img.id) }}" method="POST" class="m-0" onsubmit="return confirm('确定删除？')">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                        <button class="btn-circle-icon text-secondary hover-danger" style="background: var(--btn-bg);" title="删除">
                                            <i class="bi bi-trash-fill" style="font-size: 0.9rem;"></i>
                                        </button>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            {% else %}
                <div class="empty-celebration text-center py-5 mt-4">
                    <div class="mb-4 d-inline-flex align-items-center justify-content-center bg-success bg-opacity-10 text-success rounded-circle breathing-icon" style="width: 100px; height: 100px;">
                        <i class="bi bi-cup-hot-fill" style="font-size: 3.5rem;"></i>
                    </div>
                    <h3 class="fw-bold text-secondary mb-2">All Caught Up!</h3>
                    <p class="text-muted">暂时没有待审核的作品，喝杯咖啡吧。</p>
                </div>
            {% endif %}
        </div>

        <div class="tab-pane fade {{ 'show active' if active_tab == 'approved' else '' }}">

            <!-- 顶部工具栏 - 现代化设计 -->
            <div class="d-flex flex-wrap justify-content-between align-items-center mb-4 gap-3 px-2">
                <div class="d-flex align-items-center gap-3">
                    <!-- 全选复选框 - Windows风格 -->
                    <input type="checkbox"
                           class="form-check-input modern-checkbox m-0"
                           id="selectAllCheckbox"
                           onchange="toggleSelectAll()"
                           title="全选"
                           style="width: 18px; height: 18px; cursor: pointer;">
                    <div class="text-secondary small fw-bold text-uppercase ls-1">
                        Library ({{ approved_pagination.total }})
                    </div>
                </div>
                <form action="{{ url_for('admin.dashboard') }}" method="get" class="position-relative flex-grow-1 flex-md-grow-0" style="min-width: 280px;">
                    <input type="hidden" name="tab" value="approved">
                    <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-secondary opacity-50"></i>
                    <input type="text" name="q" value="{{ search_query }}"
                           class="form-control input-glass py-2 ps-5"
                           placeholder="Search title, prompt...">
                </form>
            </div>

            <!-- 批量操作工具栏 - 精简版 -->
            <div id="batchToolbar" class="batch-toolbar mb-3 px-2">
                <div class="glass-panel py-2 px-3 d-flex justify-content-between align-items-center shadow-sm border border-primary border-opacity-25">
                    <div class="d-flex align-items-center gap-2">
                        <span class="text-primary fw-bold" id="selectedCount">0</span>
                        <span class="text-secondary small">项已选</span>
                        <button class="btn btn-sm btn-link text-secondary p-0 ms-2 text-decoration-none" onclick="clearSelection()">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <button class="btn btn-sm btn-outline-primary rounded-pill px-3 py-1 batch-action-btn"
                                onclick="showBatchTagModal()">
                            <i class="bi bi-tags me-1"></i>标签
                        </button>
                        <button class="btn btn-sm btn-outline-danger rounded-pill px-3 py-1 batch-action-btn"
                                onclick="batchDelete()">
                            <i class="bi bi-trash me-1"></i>删除
                        </button>
                    </div>
                </div>
            </div>

            <div class="admin-list-container">
                {% for img in approved_pagination.items %}
                <div class="admin-card-row modern-list-item">
                    <div class="flex-shrink-0 d-flex align-items-center gap-2">
                        <!-- 现代化复选框 - 默认隐藏 -->
                        <input type="checkbox" class="form-check-input batch-checkbox modern-checkbox m-0 checkbox-hidden"
                               data-img-id="{{ img.id }}"
                               style="width: 18px; height: 18px; cursor: pointer;"
                               onchange="updateBatchSelection()">
                        {% set img_dict = img.to_dict() %}
                        <a href="{{ url_for('admin.edit_image', img_id=img.id, next=request.full_path) }}" class="position-relative group thumb-link">
                            <img src="{{ img_dict.thumbnail_path or img_dict.file_path }}" class="admin-thumb-compact">
                            {% if img.type == 'img2img' %}
                            <span class="position-absolute bottom-0 end-0 badge bg-black bg-opacity-50 border border-white border-opacity-25 rounded-pill m-1" style="font-size: 0.5rem;">I2I</span>
                            {% endif %}
                            <!-- Hover overlay -->
                            <div class="thumb-overlay"></div>
                        </a>
                    </div>

                    <div class="flex-grow-1 min-w-0 pe-4 d-flex flex-column justify-content-center">
                        <h6 class="fw-bold mb-1 text-truncate" style="font-size: 1rem; color: var(--text-primary);">{{ img.title }}</h6>
                        <div class="d-flex align-items-center text-secondary small text-truncate gap-3">
                            <span><i class="bi bi-person me-1 opacity-50"></i>{{ img.author }}</span>
                            <span class="opacity-50">&bull;</span>
                            <span class="font-monospace opacity-75">{{ img.created_at.strftime('%Y-%m-%d') }}</span>
                        </div>
                    </div>

                    <div class="d-none d-md-flex gap-1 me-4 flex-shrink-0 align-items-center" style="max-width: 250px; flex-wrap: wrap; justify-content: flex-end;">
                        {% for tag in img.tags[:3] %}
                        <span class="mini-tag">{{ tag.name }}</span>
                        {% endfor %}

                        {% if img.tags|length > 3 %}
                        <span class="mini-tag" style="background:transparent; border:none;">+{{ img.tags|length - 3 }}</span>
                        {% endif %}
                    </div>

                    <div class="d-flex gap-2 flex-shrink-0 align-items-center">
                        <!-- 分类切换按钮 - 文字按钮 -->
                        <button type="button"
                                class="category-toggle-btn"
                                data-img-id="{{ img.id }}"
                                data-category="gallery"
                                onclick="toggleCategory({{ img.id }}, 'gallery')"
                                style="{% if img.category == 'gallery' %}background: var(--accent-color); color: white;{% else %}background: var(--btn-bg); color: var(--text-secondary);{% endif %}">
                            <i class="bi bi-images me-1"></i>画廊
                        </button>
                        <button type="button"
                                class="category-toggle-btn"
                                data-img-id="{{ img.id }}"
                                data-category="template"
                                onclick="toggleCategory({{ img.id }}, 'template')"
                                style="{% if img.category == 'template' %}background: var(--accent-color); color: white;{% else %}background: var(--btn-bg); color: var(--text-secondary);{% endif %}">
                            <i class="bi bi-file-earmark me-1"></i>模板
                        </button>

                        <a href="{{ url_for('admin.edit_image', img_id=img.id, next=request.full_path) }}"
                           class="btn-circle-icon" title="编辑">
                            <i class="bi bi-pencil-fill" style="font-size: 0.9rem;"></i>
                        </a>
                        <form action="{{ url_for('admin.delete', img_id=img.id) }}" method="POST" class="m-0" onsubmit="return confirm('确定永久删除？')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <input type="hidden" name="next" value="{{ url_for('admin.dashboard', tab='approved', page=approved_pagination.page, q=search_query) }}"/>
                            <button class="btn-circle-icon bg-transparent text-secondary hover-danger" title="删除">
                                <i class="bi bi-trash" style="font-size: 1rem;"></i>
                            </button>
                        </form>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5">
                    <div class="d-inline-block p-4 rounded-circle mb-3" style="background: var(--btn-bg);">
                        <i class="bi bi-inbox text-secondary opacity-25 fs-1"></i>
                    </div>
                    <p class="text-muted small">暂无相关数据</p>
                </div>
                {% endfor %}
            </div>

            <div class="pagination-footer mt-5 mb-4 px-2">
                <div class="d-flex justify-content-between align-items-center flex-wrap gap-3">
                    <!-- 左侧：每页显示条数 -->
                    <div class="d-flex align-items-center gap-2">
                        <label for="perPageSelect" class="small fw-bold text-secondary text-uppercase ls-1 mb-0">每页显示</label>
                        <select id="perPageSelect" class="form-select form-select-sm"
                                style="width: auto; background: var(--btn-bg); color: var(--text-primary); border: 1px solid var(--text-secondary); border-opacity: 0.2;"
                                onchange="changePerPage(this.value)">
                            <option value="6">6 条</option>
                            <option value="12" selected>12 条</option>
                            <option value="24">24 条</option>
                            <option value="50">50 条</option>
                        </select>
                    </div>

                    <!-- 右侧：分页导航 -->
                    {% if approved_pagination.pages > 1 %}
                    <nav class="pagination-capsule">
                        {% set per_page_param = request.args.get('per_page', '') %}
                        <a class="page-btn {% if not approved_pagination.has_prev %}disabled{% endif %}"
                           href="{{ url_for('admin.dashboard', page=approved_pagination.prev_num, tab='approved', q=search_query, per_page=per_page_param or '') }}">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                        <span class="page-btn active mx-1" style="background:transparent; color:var(--text-primary);">{{ approved_pagination.page }} / {{ approved_pagination.pages }}</span>
                        <a class="page-btn {% if not approved_pagination.has_next %}disabled{% endif %}"
                           href="{{ url_for('admin.dashboard', page=approved_pagination.next_num, tab='approved', q=search_query, per_page=per_page_param or '') }}">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </nav>
                    {% endif %}
                </div>
            </div>
        </div>

        <div class="tab-pane fade {{ 'show active' if active_tab == 'data-mgmt' else '' }}">
            <div class="row g-4">

                <div class="col-12">
                    <div class="glass-panel p-4 d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center gap-4">
                            <div class="dashboard-icon-box bg-warning bg-opacity-10 text-warning m-0 flex-shrink-0">
                                <i class="bi bi-eye-slash-fill"></i>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-1">访客可见性设置</h5>
                                <p class="text-secondary small mb-0">
                                    允许未登录访客在“关于”页面切换敏感内容显示。<br>
                                    <span class="opacity-75">关闭后，敏感内容仅管理员可见。</span>
                                </p>
                            </div>
                        </div>
                        <div class="flex-shrink-0 text-end">
                            <div class="form-check form-switch d-inline-block">
                                <input class="form-check-input ios-switch" type="checkbox"
                                       id="globalToggleBtn"
                                       onchange="updateGlobalSetting(this)"
                                       {% if allow_sensitive_toggle %}checked{% endif %}>
                            </div>
                            <div id="globalStatusText" class="small fw-bold mt-1 {{ 'text-success' if allow_sensitive_toggle else 'text-secondary' }}">
                                {{ 'Access Allowed' if allow_sensitive_toggle else 'Access Denied' }}
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-12">
                    <div class="glass-panel p-4">
                        <div class="d-flex align-items-center mb-3">
                            <div class="dashboard-icon-box bg-primary bg-opacity-10 text-primary m-0 me-3" style="width: 48px; height: 48px; font-size: 1.2rem;">
                                <i class="bi bi-shield-check"></i>
                            </div>
                            <div>
                                <h5 class="fw-bold mb-0">发布审核策略 (Moderation Policy)</h5>
                                <p class="text-secondary small mb-0">开启后，用户上传的作品需管理员审核通过后才会显示。</p>
                            </div>
                        </div>

                        <div class="row g-4 pt-2">
                            <div class="col-md-6 d-flex align-items-center justify-content-between border-end border-secondary border-opacity-10 pe-md-4">
                                <div>
                                    <span class="fw-bold d-block" style="color: var(--text-primary);">画廊 (Gallery)</span>
                                    <span id="galleryStatusText" class="x-small fw-bold {{ 'text-warning' if approval_settings.gallery else 'text-success' }}">
                                        {{ '需人工审核' if approval_settings.gallery else '自动发布' }}
                                    </span>
                                </div>
                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input ios-switch" type="checkbox"
                                           id="galleryToggle"
                                           onchange="updateApprovalSetting('gallery', this)"
                                           {% if approval_settings.gallery %}checked{% endif %}>
                                </div>
                            </div>

                            <div class="col-md-6 d-flex align-items-center justify-content-between ps-md-4">
                                <div>
                                    <span class="fw-bold d-block" style="color: var(--text-primary);">模板 (Template)</span>
                                    <span id="templateStatusText" class="x-small fw-bold {{ 'text-warning' if approval_settings.template else 'text-success' }}">
                                        {{ '需人工审核' if approval_settings.template else '自动发布' }}
                                    </span>
                                </div>
                                <div class="form-check form-switch m-0">
                                    <input class="form-check-input ios-switch" type="checkbox"
                                           id="templateToggle"
                                           onchange="updateApprovalSetting('template', this)"
                                           {% if approval_settings.template %}checked{% endif %}>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="glass-panel p-4 h-100 glass-hover-card transition-transform">
                        <div class="dashboard-icon-box bg-primary bg-opacity-10 text-primary">
                            <i class="bi bi-cloud-download-fill"></i>
                        </div>
                        <h5 class="fw-bold mb-2">数据备份 (Backup)</h5>
                        <p class="text-secondary small mb-4">生成包含所有图片原图、Prompt 和元数据的完整 ZIP 归档。</p>

                        <div class="rounded-3 p-3 mb-4 border border-secondary border-opacity-10" style="background: var(--btn-bg);">
                            <div class="d-flex justify-content-between mb-2 small">
                                <span class="text-muted">Images</span>
                                <span class="fw-bold">{{ stats.total_images }}</span>
                            </div>
                            <div class="d-flex justify-content-between small">
                                <span class="text-muted">Tags</span>
                                <span class="fw-bold">{{ stats.total_tags }}</span>
                            </div>
                        </div>

                        <form action="{{ url_for('admin.export_zip') }}" method="POST">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                            <button type="submit" class="btn btn-light w-100 fw-bold border text-primary shadow-sm py-2">
                                下载 ZIP 归档
                            </button>
                        </form>
                    </div>
                </div>

                <div class="col-md-6">
                    <div class="glass-panel p-4 h-100 glass-hover-card transition-transform">
                        <div class="dashboard-icon-box bg-success bg-opacity-10 text-success">
                            <i class="bi bi-cloud-upload-fill"></i>
                        </div>
                        <h5 class="fw-bold mb-2">数据恢复 (Restore)</h5>
                        <p class="text-secondary small mb-4">上传之前导出的 ZIP 包以恢复或迁移数据。重复图片将被自动跳过。</p>

                        <div class="mb-3">
                            <input type="file" id="zipFile" class="form-control form-control-apple" accept=".zip">
                        </div>

                        <button id="btnStartImport" class="btn btn-success w-100 text-white shadow-sm fw-bold py-2"
                                style="background: #34c759; border: none;">
                            开始导入
                        </button>

                        <div id="syncLog" class="terminal-log mt-3 d-none rounded-3 p-3 small custom-scrollbar"
                             style="background:#222; color:#0f0; max-height:150px; overflow-y: auto;"></div>
                    </div>
                </div>

            </div>
        </div>

    </div>
</div>

<div class="modal fade" id="batchTagModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-panel border-0 shadow-lg overflow-hidden" style="background: var(--modal-bg);">
            <div class="modal-header border-bottom-0 pb-0 pt-4 px-4">
                <div>
                    <h4 class="fw-bold mb-1">批量修改标签</h4>
                    <p class="text-secondary small mb-0">为选中的作品批量添加或删除标签</p>
                </div>
                <button type="button" class="btn-close rounded-circle p-2" data-bs-dismiss="modal" style="background: var(--btn-bg);"></button>
            </div>
            <div class="modal-body p-4">
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-secondary mb-2">操作类型</label>
                    <select class="form-select" id="batchTagAction" style="background: var(--btn-bg); color: var(--text-primary); border: 1px solid var(--text-secondary); border-opacity: 0.2;">
                        <option value="add">添加标签</option>
                        <option value="remove">删除标签</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label fw-bold small text-uppercase text-secondary mb-2">选择标签 (可多选)</label>
                    <div class="border rounded-3 p-3 custom-scrollbar" style="background: var(--btn-bg); max-height: 250px; overflow-y: auto;">
                        {% for tag in all_tags %}
                        <div class="form-check mb-2">
                            <input class="form-check-input batch-tag-checkbox" type="checkbox" value="{{ tag.id }}" id="btag{{ tag.id }}">
                            <label class="form-check-label" for="btag{{ tag.id }}" style="color: var(--text-primary);">
                                {{ tag.name }}
                            </label>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="d-flex gap-2 justify-content-end">
                    <button type="button" class="btn btn-secondary rounded-pill px-4 py-2 fw-bold" data-bs-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary rounded-pill px-4 py-2 fw-bold" onclick="submitBatchTagModify()">确认修改</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="tagsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content glass-panel border-0 shadow-lg overflow-hidden" style="background: var(--modal-bg);">
            <div class="modal-header border-bottom-0 pb-0 pt-4 px-4">
                <div>
                    <h4 class="fw-bold mb-1">标签管理</h4>
                    <p class="text-secondary small mb-0">Sensitivity & Renaming</p>
                </div>
                <button type="button" class="btn-close rounded-circle p-2" data-bs-dismiss="modal" style="background: var(--btn-bg);"></button>
            </div>
            <div class="modal-body custom-scrollbar p-4" style="max-height: 60vh; overflow-y: auto;">
                <div class="d-flex flex-column gap-2">
                    {% for tag in all_tags %}
                    <div class="list-row-item py-2 px-3 border shadow-sm" style="background: var(--sidebar-bg);">
                        <div class="flex-grow-1 d-flex align-items-center">
                            <i class="bi bi-hash text-secondary opacity-50 me-2"></i>
                            <form action="{{ url_for('admin.update_tag') }}" method="POST" class="flex-grow-1">
                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                <input type="hidden" name="tag_id" value="{{ tag.id }}"/>
                                <input type="text" name="new_name" value="{{ tag.name }}"
                                       class="form-control border-0 bg-transparent fw-bold p-0 shadow-none" style="color: var(--text-primary);"
                                       style="font-size: 0.95rem;"
                                       onchange="this.form.submit()">
                            </form>
                        </div>
                        <div class="d-flex align-items-center gap-2 border-start ps-3">
                            <label class="form-check-label x-small text-secondary fw-bold text-uppercase" for="ts{{ tag.id }}">NSFW</label>
                            <div class="form-check form-switch m-0">
                                <input class="form-check-input ios-switch danger" type="checkbox"
                                       id="ts{{ tag.id }}"
                                       onchange="updateTagSensitive(this, {{ tag.id }})"
                                       style="transform: scale(0.7);"
                                       {% if tag.is_sensitive %}checked{% endif %}>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // ===== 分页设置相关函数 =====

    // 改变每页显示条数
    function changePerPage(perPage) {
        // 获取当前URL的所有参数
        const searchParams = new URLSearchParams(window.location.search);

        // 更新每页显示条数和页码
        searchParams.set('per_page', perPage);
        searchParams.set('page', '1');  // 重置到第1页

        // 确保 tab 为 'approved'（因为这个selector只在approved标签页显示）
        if (!searchParams.has('tab')) {
            searchParams.set('tab', 'approved');
        }

        window.location.href = '{{ url_for("admin.dashboard") }}?' + searchParams.toString();
    }

    // 初始化：设置select的值为当前per_page
    document.addEventListener('DOMContentLoaded', function() {
        const params = new URLSearchParams(window.location.search);
        const currentPerPage = params.get('per_page');
        if (currentPerPage) {
            const select = document.getElementById('perPageSelect');
            if (select) {
                select.value = currentPerPage;
            }
        }
    });

    // ===== 批量操作相关函数 =====

    // 更新批量选择状态
    function updateBatchSelection() {
        const checkboxes = document.querySelectorAll('.batch-checkbox');
        const checkedBoxes = document.querySelectorAll('.batch-checkbox:checked');
        const toolbar = document.getElementById('batchToolbar');
        const countSpan = document.getElementById('selectedCount');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');

        // 显示/隐藏工具栏和复选框
        if (checkedBoxes.length > 0) {
            toolbar.classList.add('show');
            countSpan.textContent = checkedBoxes.length;

            // 显示所有复选框并更新列表项选中状态
            checkboxes.forEach(cb => {
                cb.classList.remove('checkbox-hidden');
                const row = cb.closest('.admin-card-row');
                if (cb.checked) {
                    row?.classList.add('selected');
                } else {
                    row?.classList.remove('selected');
                }
            });
        } else {
            toolbar.classList.remove('show');
            // 隐藏所有复选框
            checkboxes.forEach(cb => {
                cb.classList.add('checkbox-hidden');
                cb.closest('.admin-card-row')?.classList.remove('selected');
            });
        }

        // 更新全选checkbox状态(三态)
        if (checkboxes.length === 0) {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedBoxes.length === checkboxes.length) {
            selectAllCheckbox.checked = true;
            selectAllCheckbox.indeterminate = false;
        } else if (checkedBoxes.length > 0) {
            selectAllCheckbox.indeterminate = true;
        } else {
            selectAllCheckbox.checked = false;
            selectAllCheckbox.indeterminate = false;
        }
    }

    // 全选/取消全选 - Windows风格
    function toggleSelectAll() {
        const checkboxes = document.querySelectorAll('.batch-checkbox');
        const selectAllCheckbox = document.getElementById('selectAllCheckbox');
        const shouldCheck = selectAllCheckbox.checked;

        checkboxes.forEach(cb => {
            cb.checked = shouldCheck;
        });

        updateBatchSelection();
    }

    // 清除选择
    function clearSelection() {
        document.querySelectorAll('.batch-checkbox').forEach(cb => {
            cb.checked = false;
        });
        updateBatchSelection();
    }

    // 获取选中的图片ID
    function getSelectedImageIds() {
        const checkedBoxes = document.querySelectorAll('.batch-checkbox:checked');
        return Array.from(checkedBoxes).map(cb => parseInt(cb.dataset.imgId));
    }

    // 批量删除
    function batchDelete() {
        const imageIds = getSelectedImageIds();
        if (imageIds.length === 0) {
            alert('请先选择要删除的图片');
            return;
        }

        if (!confirm(`确定要删除选中的 ${imageIds.length} 张图片吗？此操作不可恢复！`)) {
            return;
        }

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch("{{ url_for('admin.batch_delete') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ image_ids: imageIds })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                alert(data.message);
                location.reload();
            } else {
                alert('操作失败: ' + data.message);
            }
        })
        .catch(err => {
            alert('网络错误，请重试');
            console.error(err);
        });
    }

    // 显示批量修改标签弹窗
    function showBatchTagModal() {
        const imageIds = getSelectedImageIds();
        if (imageIds.length === 0) {
            alert('请先选择要修改的图片');
            return;
        }

        // 清空之前的选择
        document.querySelectorAll('.batch-tag-checkbox').forEach(cb => {
            cb.checked = false;
        });

        const modal = new bootstrap.Modal(document.getElementById('batchTagModal'));
        modal.show();
    }

    // 提交批量标签修改
    function submitBatchTagModify() {
        const imageIds = getSelectedImageIds();
        const tagCheckboxes = document.querySelectorAll('.batch-tag-checkbox:checked');
        const tagIds = Array.from(tagCheckboxes).map(cb => parseInt(cb.value));
        const action = document.getElementById('batchTagAction').value;

        if (tagIds.length === 0) {
            alert('请至少选择一个标签');
            return;
        }

        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch("{{ url_for('admin.batch_modify_tags') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                image_ids: imageIds,
                tag_ids: tagIds,
                action: action
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                alert(data.message);
                bootstrap.Modal.getInstance(document.getElementById('batchTagModal')).hide();
                location.reload();
            } else {
                alert('操作失败: ' + data.message);
            }
        })
        .catch(err => {
            alert('网络错误，请重试');
            console.error(err);
        });
    }

    // 快速切换分类（画廊/模板）
    function toggleCategory(imgId, category) {
        const categoryText = category === 'gallery' ? '画廊' : '模板';
        const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content');

        fetch(`/admin/toggle-category/${imgId}/${category}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            }
        })
        .then(res => res.json())
        .then(data => {
            if (data.status === 'ok') {
                // 找到对应的行
                const allButtons = document.querySelectorAll(`.category-toggle-btn[data-img-id="${imgId}"]`);

                // 更新所有按钮的样式
                allButtons.forEach(btn => {
                    const btnCategory = btn.getAttribute('data-category');
                    if (btnCategory === category) {
                        // 当前选中的按钮 - 激活
                        btn.style.background = 'var(--accent-color)';
                        btn.style.color = 'white';
                    } else {
                        // 未选中的按钮 - 恢复
                        btn.style.background = 'var(--btn-bg)';
                        btn.style.color = 'var(--text-secondary)';
                    }
                });

                // 显示成功提示
                const toast = document.createElement('div');
                toast.className = 'alert alert-success alert-dismissible fade show position-fixed';
                toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
                toast.innerHTML = `
                    <i class="bi bi-check-circle me-2"></i>
                    已切换为: ${categoryText}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.body.appendChild(toast);

                // 自动关闭 Toast
                setTimeout(() => {
                    toast.remove();
                }, 3000);
            } else {
                alert('切换失败: ' + data.message);
            }
        })
        .catch(err => {
            alert('网络错误，请重试');
            console.error(err);
        });
    }

    // ===== 原有的其他函数 =====

    // Toggle Global Setting (敏感内容)
    function updateGlobalSetting(checkbox) {
        const isChecked = checkbox.checked;
        const statusText = document.getElementById('globalStatusText');
        statusText.textContent = isChecked ? 'Access Allowed' : 'Access Denied';
        statusText.className = `small fw-bold mt-1 ${isChecked ? 'text-success' : 'text-secondary'}`;

        fetch("{{ url_for('admin.update_global_setting') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ allow_toggle: isChecked })
        }).catch(() => { checkbox.checked = !isChecked; alert('设置保存失败'); });
    }

    // Toggle Approval Setting (审核策略)
    function updateApprovalSetting(type, checkbox) {
        const isChecked = checkbox.checked;
        const statusText = document.getElementById(type + 'StatusText');

        // 更新界面文字状态
        statusText.textContent = isChecked ? '需人工审核' : '自动发布';
        statusText.className = `x-small fw-bold ${isChecked ? 'text-warning' : 'text-success'}`;

        // 构建请求数据
        let payload = {};
        if (type === 'gallery') payload = { approval_gallery: isChecked };
        if (type === 'template') payload = { approval_template: isChecked };

        // 发送请求
        fetch("{{ url_for('admin.update_global_setting') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify(payload)
        }).catch(err => {
            checkbox.checked = !isChecked; // 回滚状态
            alert('设置保存失败');
            console.error(err);
        });
    }

    // Toggle Tag Sensitive
    function updateTagSensitive(checkbox, tagId) {
        const isSensitive = checkbox.checked;
        checkbox.style.opacity = '0.5';
        fetch("{{ url_for('admin.update_tag') }}", {
            method: 'POST',
            headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token() }}' },
            body: JSON.stringify({ tag_id: tagId, is_sensitive: isSensitive })
        }).then(res => {
            checkbox.style.opacity = '1';
            if(!res.ok) throw new Error();
        }).catch(() => { checkbox.checked = !isSensitive; checkbox.style.opacity = '1'; });
    }

    // Import Logic
    document.getElementById('btnStartImport').addEventListener('click', async function() {
        const fileInput = document.getElementById('zipFile');
        if (!fileInput.files.length) return alert('请选择文件');

        const btn = this; const logDiv = document.getElementById('syncLog');
        btn.disabled = true; btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
        logDiv.classList.remove('d-none'); logDiv.innerText = 'Starting upload...\n';

        try {
            const formData = new FormData(); formData.append('zip_file', fileInput.files[0]); formData.append('csrf_token', '{{ csrf_token() }}');
            const response = await fetch("{{ url_for('admin.import_zip') }}", { method: 'POST', body: formData });
            const reader = response.body.getReader();
            while (true) {
                const { done, value } = await reader.read();
                if (done) break;
                logDiv.innerText += new TextDecoder().decode(value);
                logDiv.scrollTop = logDiv.scrollHeight;
            }
        } catch (e) { logDiv.innerText += `\nError: ${e}`; }
        finally { btn.disabled = false; btn.innerText = '开始导入'; fileInput.value = ''; }
    });
</script>

<style>
    /* Hover Danger helper for icon buttons */
    .hover-danger:hover { background-color: #ff3b30 !important; color: white !important; }

    /* ===== 现代化批量操作样式 ===== */

    /* 默认隐藏复选框 */
    .checkbox-hidden {
        opacity: 0 !important;
        width: 0 !important;
        margin: 0 !important;
        pointer-events: none;
    }

    /* hover时显示复选框 */
    .modern-list-item:hover .checkbox-hidden {
        opacity: 0.7 !important;
        width: 18px !important;
        pointer-events: auto;
    }

    /* Modern checkbox styling */
    .modern-checkbox {
        transition: all 0.2s ease;
        border-radius: 4px;
        border: 2px solid var(--text-secondary);
        opacity: 0.5;
    }

    .modern-checkbox:hover {
        opacity: 1 !important;
        border-color: var(--bs-primary);
    }

    .modern-checkbox:checked {
        opacity: 1 !important;
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
    }

    .modern-checkbox:indeterminate {
        opacity: 1 !important;
        background-color: var(--bs-primary);
        border-color: var(--bs-primary);
        background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 20 20'%3e%3cpath fill='none' stroke='%23fff' stroke-linecap='round' stroke-linejoin='round' stroke-width='3' d='M6 10h8'/%3e%3c/svg%3e");
    }

    /* 全选checkbox样式优化 */
    #selectAllCheckbox {
        opacity: 0.4;
    }

    #selectAllCheckbox:hover {
        opacity: 1 !important;
    }

    #selectAllCheckbox:checked,
    #selectAllCheckbox:indeterminate {
        opacity: 1 !important;
    }

    /* Batch toolbar animations - 精简高度 */
    .batch-toolbar {
        max-height: 0;
        overflow: hidden;
        opacity: 0;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        transform: translateY(-10px);
    }

    .batch-toolbar.show {
        max-height: 70px;
        opacity: 1;
        transform: translateY(0);
    }

    /* Glass panel effect for toolbar */
    .glass-panel {
        background: var(--btn-bg);
        backdrop-filter: blur(10px);
        border-radius: 12px;
    }

    /* Modern list item effects */
    .modern-list-item {
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        border-radius: 8px;
        padding: 12px 8px;
        margin-bottom: 4px;
    }

    .modern-list-item:hover {
        background-color: var(--btn-bg);
        transform: translateX(4px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .modern-list-item.selected {
        background-color: rgba(var(--bs-primary-rgb), 0.08);
        border-left: 4px solid var(--bs-primary);
        padding-left: 8px;
    }

    /* Thumbnail hover overlay */
    .thumb-link {
        position: relative;
        overflow: hidden;
        border-radius: 8px;
        display: block;
    }

    .thumb-overlay {
        position: absolute;
        inset: 0;
        background: linear-gradient(135deg, rgba(0,0,0,0) 0%, rgba(0,0,0,0.3) 100%);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }

    .thumb-link:hover .thumb-overlay {
        opacity: 1;
    }

    /* Batch action buttons */
    .batch-action-btn {
        transition: all 0.2s ease;
        position: relative;
    }

    .batch-action-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 6px 16px rgba(0,0,0,0.15);
    }

    .batch-action-btn:active {
        transform: translateY(0);
    }

    .batch-action-btn.btn-danger:hover {
        background-color: #ff3b30 !important;
        border-color: #ff3b30 !important;
    }

    /* Utility classes */
    .cursor-pointer {
        cursor: pointer;
    }

    .user-select-none {
        user-select: none;
        -webkit-user-select: none;
        -moz-user-select: none;
        -ms-user-select: none;
    }

    /* Select all container */
    .select-all-container {
        transition: all 0.2s ease;
    }

    .select-all-container:hover .modern-checkbox {
        opacity: 1;
    }

    .select-all-container label {
        transition: color 0.2s ease;
    }

    .select-all-container:hover label {
        color: var(--text-primary) !important;
    }

    /* 紧凑缩略图样式 */
    .admin-thumb-compact {
        width: 56px;
        height: 56px;
        object-fit: cover;
        border-radius: 6px;
        transition: transform 0.3s ease;
    }

    .thumb-link:hover .admin-thumb-compact {
        transform: scale(1.05);
    }

    /* Smooth animations for row highlighting */
    @keyframes slideInRight {
        from {
            opacity: 0;
            transform: translateX(-20px);
        }
        to {
            opacity: 1;
            transform: translateX(0);
        }
    }

    .modern-list-item {
        animation: slideInRight 0.3s ease-out;
    }

    /* Badge for selected count */
    #selectedCount {
        font-size: 1.1em;
        font-weight: 700;
        display: inline-block;
        min-width: 24px;
        text-align: center;
    }

    /* Pagination footer styles */
    .pagination-footer {
        border-top: 1px solid var(--text-secondary);
        border-opacity: 0.1;
        padding-top: 2rem !important;
    }

    /* Per-page select styling */
    #perPageSelect {
        min-width: 100px;
        padding: 0.375rem 0.75rem;
        border-radius: 6px;
        font-size: 0.875rem;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    #perPageSelect:hover {
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    #perPageSelect:focus {
        box-shadow: 0 0 0 3px rgba(var(--bs-primary-rgb), 0.25);
    }

    /* 分类切换按钮样式 */
    .category-toggle-btn {
        padding: 6px 12px;
        border-radius: 6px;
        border: none;
        font-size: 0.85rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s ease;
        display: inline-flex;
        align-items: center;
        white-space: nowrap;
    }

    .category-toggle-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    .category-toggle-btn:active {
        transform: translateY(0);
    }

    .category-toggle-btn i {
        font-size: 0.9rem;
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .modern-list-item:hover {
            transform: translateX(2px);
        }

        .batch-toolbar.show {
            max-height: 250px;
        }

        .pagination-footer .d-flex {
            flex-direction: column-reverse;
        }

        #perPageSelect {
            width: 100% !important;
        }
    }
</style>
{% endblock %}