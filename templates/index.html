{% extends 'base.html' %}
{% block title %}Prompt Manager{% endblock %}

{% block content %}
<div class="d-flex w-100" style="min-height: 100vh;">

    <div class="d-none d-md-block flex-shrink-0" style="width: 240px; z-index: 100;">
        <div class="sidebar-sticky custom-scrollbar">
            <div class="px-3 mb-4 mt-2">
                <h5 class="fw-bold m-0" style="font-family: serif; font-style: italic; letter-spacing: 1px;">Prompt<br>Manager</h5>
            </div>

            <div class="nav-category">Library</div>
            <a href="{{ url_for(request.endpoint) }}" class="nav-item-apple {{ 'active' if not active_tag else '' }}">
                <i class="bi bi-grid-fill me-3 small"></i>All Photos
            </a>

            <div class="nav-category mt-4">Tags</div>
            {% for tag_item in all_tags %}
            <a href="{{ url_for(request.endpoint, tag=tag_item.tag.name) }}" class="nav-item-apple {{ 'active' if active_tag == tag_item.tag.name else '' }}">
                <i class="bi bi-hash me-3 small opacity-50"></i>{{ tag_item.tag.name }}
                <span class="tag-count">{{ tag_item.count }}</span>
            </a>
            {% endfor %}
        </div>
    </div>

    <div class="flex-grow-1 transition-bg" style="background: var(--bg-color); overflow-x: hidden;">

        <!-- 顶栏：标题 + 搜索栏 + 按钮 -->
        <div class="px-4 px-lg-5 pt-3 pb-3">
            <div class="d-flex justify-content-between align-items-center gap-3 mb-2">
                <div>
                    <h1 class="fw-bold mb-0 art-title" style="font-size: 2.2rem; letter-spacing: -1px;">
                        {{ active_tag or ('Templates' if request.endpoint == 'public.templates_index' else 'Collection') }}
                    </h1>
                    <p class="m-0 small" style="color: var(--text-secondary); font-size: 0.85rem;">
                        {{ pagination.total }} pieces of art
                    </p>
                </div>

                <!-- 搜索栏 (嵌入顶栏) -->
                <form action="{{ url_for(request.endpoint) }}" method="get" class="flex-shrink-0" style="min-width: 200px; max-width: 280px;">
                    <div class="position-relative">
                        <i class="bi bi-search position-absolute top-50 start-0 translate-middle-y ms-3 text-muted"></i>
                        <input type="text" name="q" value="{{ active_search or '' }}"
                               class="form-control border-0 shadow-sm rounded-pill py-2"
                               placeholder="Search..."
                               style="width: 100%; padding-left: 2.5rem; background: var(--sidebar-bg); color: var(--text-primary);">
                        <input type="hidden" name="sort" value="{{ current_sort }}">
                        {% if active_tag %}
                        <input type="hidden" name="tag" value="{{ active_tag }}">
                        {% endif %}
                        {% if active_type %}
                        <input type="hidden" name="type" value="{{ active_type }}">
                        {% endif %}
                    </div>
                </form>
            </div>

            <!-- 过滤和排序按钮组 -->
            <div class="d-flex justify-content-start gap-2 flex-wrap mt-2">
                <!-- 图片类型过滤器 -->
                <nav class="segmented-control segmented-control-compact">
                    <a href="{{ url_for(request.endpoint, sort=current_sort, tag=active_tag, q=active_search) }}"
                       class="nav-link {{ 'active' if not active_type else '' }}"
                       title="Show all image types">
                       <i class="bi bi-images"></i><span>All</span>
                    </a>
                    <a href="{{ url_for(request.endpoint, sort=current_sort, tag=active_tag, q=active_search, type='txt2img') }}"
                       class="nav-link {{ 'active' if active_type == 'txt2img' else '' }}"
                       title="Text to Image">
                       <i class="bi bi-chat-dots"></i><span>T2I</span>
                    </a>
                    <a href="{{ url_for(request.endpoint, sort=current_sort, tag=active_tag, q=active_search, type='img2img') }}"
                       class="nav-link {{ 'active' if active_type == 'img2img' else '' }}"
                       title="Image to Image">
                       <i class="bi bi-image"></i><span>I2I</span>
                    </a>
                </nav>

                <!-- 排序控制 -->
                <nav class="segmented-control segmented-control-compact">
                    <a href="{{ url_for(request.endpoint, sort='date', tag=active_tag, q=active_search, type=active_type) }}"
                       class="nav-link {{ 'active' if current_sort == 'date' else '' }}"
                       title="Sort by latest">
                       <i class="bi bi-clock-history"></i><span>Latest</span>
                    </a>
                    <a href="{{ url_for(request.endpoint, sort='hot', tag=active_tag, q=active_search, type=active_type) }}"
                       class="nav-link {{ 'active' if current_sort == 'hot' else '' }}"
                       title="Sort by trending">
                       <i class="bi bi-fire"></i><span>Trending</span>
                    </a>
                    <a href="{{ url_for(request.endpoint, sort='random', tag=active_tag, q=active_search, type=active_type) }}"
                       class="nav-link {{ 'active' if current_sort == 'random' else '' }}"
                       title="Show random">
                       <i class="bi bi-shuffle"></i><span>Random</span>
                    </a>
                </nav>
            </div>
        </div>

        <div class="px-2 px-md-4 px-lg-5 pt-2 pb-5">
            <div class="gallery-masonry">
                {% for img in images %}
                <div class="gallery-item group">
                    <div class="art-frame cursor-zoom" onclick="showDetail(this)">

                        <script type="application/json" class="img-data">
                            {% set img_dict = img.to_dict() %}
                            {{ img_dict | tojson | safe }}
                        </script>

                        {% if config.USE_THUMBNAIL_IN_PREVIEW %}
                            <img src="{{ img_dict.thumbnail_path or img_dict.file_path }}"
                                 alt="{{ img.title }}"
                                 loading="lazy"
                                 onload="this.classList.add('reveal')"
                                 {% if img_dict.lqip_data %}style="background-image: url('{{ img_dict.lqip_data }}'); background-size: cover;"{% endif %}>
                        {% else %}
                            <img src="{{ img_dict.file_path }}"
                                 alt="{{ img.title }}"
                                 loading="lazy"
                                 onload="this.classList.add('reveal')"
                                 {% if img_dict.lqip_data %}style="background-image: url('{{ img_dict.lqip_data }}'); background-size: cover;"{% endif %}>
                        {% endif %}

                        <span class="position-absolute top-0 end-0 m-2 badge bg-black bg-opacity-25 backdrop-blur rounded-1 fw-normal"
                              style="font-size: 0.6rem; padding: 3px 6px;">
                            {{ 'T2I' if img.type == 'txt2img' else 'I2I' }}
                        </span>
                    </div>

                    <div class="art-info">
                        <div class="art-title text-truncate" style="color: var(--text-primary);">{{ img.title }}</div>
                        <div class="art-meta d-flex justify-content-between align-items-center mt-1">
                            <div class="d-flex align-items-center text-truncate" style="max-width: 60%;">
                                <span class="me-2">{{ img.author or '' }}</span>
                                {% if current_sort == 'hot' and img.heat_score > 0 %}
                                <span class="d-flex align-items-center small text-secondary opacity-75 ms-1" style="font-size: 0.7rem;">
                                    <i class="bi bi-fire me-1"></i>{{ img.heat_score }}
                                </span>
                                {% endif %}
                            </div>

                            <div class="d-flex flex-wrap justify-content-end gap-2" style="max-width: 50%;">
                                {% for tag in img.tags[:3] %}
                                <span class="mini-tag">{{ tag.name }}</span>
                                {% endfor %}
                                {% if img.tags|length > 3 %}
                                <span class="mini-tag px-1 text-muted" style="background:transparent; border:none;">+{{ img.tags|length - 3 }}</span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="text-center py-5 w-100" style="color: var(--text-secondary); break-inside: avoid;">
                    <i class="bi bi-image fs-1 opacity-25"></i>
                    <p class="mt-3">No art pieces found.</p>
                </div>
                {% endfor %}
            </div>
        </div>

        {% if pagination.pages > 1 %}
        <div class="pagination-container">
            <nav class="pagination-modern">
                <a class="page-link-item {% if not pagination.has_prev %}disabled{% endif %}"
                   href="{{ url_for(request.endpoint, page=pagination.prev_num, tag=active_tag, q=active_search, sort=current_sort, type=active_type) }}"
                   title="Previous">
                    <i class="bi bi-chevron-left small"></i>
                </a>

                {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        {% if page_num != pagination.page %}
                            <a class="page-link-item"
                               href="{{ url_for(request.endpoint, page=page_num, tag=active_tag, q=active_search, sort=current_sort, type=active_type) }}">
                                {{ page_num }}
                            </a>
                        {% else %}
                            <span class="page-link-item active">{{ page_num }}</span>
                        {% endif %}
                    {% else %}
                        <span class="page-ellipsis"><i class="bi bi-three-dots"></i></span>
                    {% endif %}
                {% endfor %}

                <a class="page-link-item {% if not pagination.has_next %}disabled{% endif %}"
                   href="{{ url_for(request.endpoint, page=pagination.next_num, tag=active_tag, q=active_search, sort=current_sort, type=active_type) }}"
                   title="Next">
                    <i class="bi bi-chevron-right small"></i>
                </a>
            </nav>
        </div>
        {% endif %}

    </div>
</div>

<div class="offcanvas offcanvas-start" tabindex="-1" id="mobileTagSidebar" style="background: var(--sidebar-bg);">
    <div class="offcanvas-header border-bottom">
        <h5 class="offcanvas-title fw-bold">筛选</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body custom-scrollbar">
        <div class="nav-category mt-0">Library</div>
        <a href="{{ url_for(request.endpoint) }}" class="nav-item-apple {{ 'active' if not active_tag else '' }}">
            <i class="bi bi-grid-fill me-3 small"></i>全部作品
        </a>

        <div class="nav-category mt-4">图片类型</div>
        <a href="{{ url_for(request.endpoint, sort=current_sort, q=active_search) }}" class="nav-item-apple {{ 'active' if not active_type else '' }}">
            <i class="bi bi-images me-3 small opacity-50"></i>全部类型
        </a>
        <a href="{{ url_for(request.endpoint, sort=current_sort, q=active_search, type='txt2img') }}" class="nav-item-apple {{ 'active' if active_type == 'txt2img' else '' }}">
            <i class="bi bi-chat-dots me-3 small opacity-50"></i>Text to Image (T2I)
        </a>
        <a href="{{ url_for(request.endpoint, sort=current_sort, q=active_search, type='img2img') }}" class="nav-item-apple {{ 'active' if active_type == 'img2img' else '' }}">
            <i class="bi bi-image me-3 small opacity-50"></i>Image to Image (I2I)
        </a>

        <div class="nav-category mt-4">标签</div>
        {% for tag_item in all_tags %}
        <a href="{{ url_for(request.endpoint, tag=tag_item.tag.name, type=active_type) }}" class="nav-item-apple {{ 'active' if active_tag == tag_item.tag.name else '' }}">
            <i class="bi bi-hash me-3 small opacity-50"></i>{{ tag_item.tag.name }}
            <span class="tag-count">{{ tag_item.count }}</span>
        </a>
        {% endfor %}
    </div>
</div>

<div class="modal fade" id="detailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-xl">
        <div class="modal-content border-0 shadow-lg overflow-hidden" style="border-radius: 1rem;">
            <div class="modal-body p-0">
                <div class="row g-0 modal-fixed-height" style="height: 85vh; min-height: 500px;">

                    <div class="col-lg-8 d-flex align-items-center justify-content-center position-relative h-100" style="background: black;">
                        <button type="button" class="btn-close btn-close-white position-absolute top-0 end-0 m-4 p-2 bg-dark bg-opacity-50 rounded-circle" data-bs-dismiss="modal" style="z-index: 10;"></button>
                        <img id="modalImg" src="" class="img-fluid" style="max-height: 95%; max-width: 95%; object-fit: contain;">
                    </div>

                    <div class="col-lg-4 d-flex flex-column border-start border-secondary border-opacity-10 h-100" style="background-color: var(--modal-bg); overflow: hidden;">
                        <div class="p-4 custom-scrollbar flex-grow-1" style="overflow-y: auto;">

                            <h4 id="modalTitle" class="fw-bold mb-1" style="color: var(--text-primary);"></h4>
                            <div class="mb-4 small" style="color: var(--text-secondary);" id="modalAuthor"></div>

                            <div id="modalTags" class="mb-4 d-flex flex-wrap gap-2"></div>

                            <div id="modalDescSection" class="mb-4 d-none">
                                <label class="text-uppercase small fw-bold mb-2 text-secondary">Info & Usage</label>
                                <div class="p-3 rounded-3" style="background-color: var(--btn-bg); font-size: 0.9rem; color: var(--text-primary);">
                                    <p id="modalDesc" class="mb-0 text-break" style="white-space: pre-wrap;"></p>
                                </div>
                            </div>

                            <div id="modalRefsSection" class="mb-4 d-none">
                                <label class="text-uppercase small fw-bold mb-2 text-secondary">参考图</label>
                                <div id="modalRefs" class="d-flex gap-2 overflow-auto pb-2 custom-scrollbar"></div>
                            </div>

                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-end mb-2 px-1">
                                    <label class="text-uppercase small fw-bold text-secondary mb-0">Prompt</label>

                                    <button class="btn btn-sm text-secondary p-0 fw-bold d-flex align-items-center transition-colors"
                                            onclick="copyModalPrompt()"
                                            id="btnCopyPrompt"
                                            style="font-size: 0.8rem; border: none; background: transparent; letter-spacing: 0.3px;">
                                        <i class="bi bi-clipboard me-1"></i> <span>Copy</span>
                                    </button>
                                </div>

                                <div class="p-3 rounded-3 position-relative prompt-box-apple" style="background-color: var(--btn-bg);">
                                    <code id="modalPrompt" class="d-block text-break custom-scrollbar"
                                          style="font-size: 0.9rem; color: var(--text-primary); max-height: 180px; overflow-y: auto; white-space: pre-wrap; line-height: 1.6;"></code>
                                </div>

                                <div id="modalVarsSection" class="mt-4 d-none animate-up" style="animation-delay: 0.1s;">
                                    <label class="text-uppercase small fw-bold text-secondary mb-2 px-1">变量替换</label>
                                    <div id="modalVarsContainer" class="d-flex flex-column gap-2">
                                        </div>
                                </div>
                            </div>
                        </div>

                        <div id="admin-actions" class="d-none mt-auto flex-shrink-0 border-top border-secondary border-opacity-10" style="background: rgba(128,128,128,0.03);">
                            <div class="d-flex justify-content-center align-items-center gap-3 p-3">
                                <a id="btn-edit-art" href="#" class="btn-circle-icon shadow-sm text-secondary" style="background: var(--sidebar-bg);" title="编辑作品">
                                    <i class="bi bi-pencil-fill"></i>
                                </a>
                                <form id="form-delete-art" method="POST" action="" onsubmit="return confirm('确定永久删除该作品吗？');" class="m-0">
                                     <input type="hidden" name="csrf_token" value="{{ csrf_token() }}"/>
                                     <button class="btn-circle-icon shadow-sm text-danger hover-danger" style="background: var(--sidebar-bg);" title="永久删除">
                                        <i class="bi bi-trash-fill"></i>
                                     </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="{{ url_for('static', filename='js/gallery.js') }}"></script>

<!-- Search Debouncing Feature -->
<script>
(function() {
    const searchInput = document.querySelector('input[name="q"]');
    const searchForm = document.querySelector('form[method="get"][action*="endpoint"]');

    if (!searchInput || !searchForm) return;

    // 防抖定时器
    let debounceTimer = null;
    const DEBOUNCE_DELAY = 400; // 毫秒

    /**
     * 执行搜索提交
     */
    function performSearch() {
        // 清空定时器
        if (debounceTimer) {
            clearTimeout(debounceTimer);
            debounceTimer = null;
        }

        // 提交表单
        searchForm.submit();
    }

    /**
     * 防抖搜索处理
     * 在用户停止输入后 DEBOUNCE_DELAY 毫秒后提交搜索
     */
    function debouncedSearch() {
        // 清除之前的定时器
        if (debounceTimer) {
            clearTimeout(debounceTimer);
        }

        // 设置新的定时器
        debounceTimer = setTimeout(() => {
            performSearch();
        }, DEBOUNCE_DELAY);
    }

    /**
     * 监听搜索框的输入事件
     * 不使用 change 事件，因为用户可能想查看实时搜索结果
     */
    searchInput.addEventListener('input', debouncedSearch);

    /**
     * 用户按 Enter 键时立即提交
     * 不等待防抖延迟，立即执行搜索
     */
    searchInput.addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            e.preventDefault();
            performSearch();
        }
    });
})();
</script>
{% endblock %}